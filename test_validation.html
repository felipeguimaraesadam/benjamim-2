<!DOCTYPE html>
<html>
<head>
    <title>Teste de Validação - CompraForm</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>Teste de Validação - CompraForm</h1>
    <div id="results"></div>
    
    <script>
        // Simular a lógica de validação do CompraForm
        function validateForm(items, obraId, dataCompra, desconto) {
            const newErrors = {};
            
            if (!obraId) newErrors.obraId = 'Obra é obrigatória.';
            if (!dataCompra) newErrors.dataCompra = 'Data da compra é obrigatória.';
            
            const currentDescontoStr = String(desconto);
            const standardizedDesconto = currentDescontoStr.replace(',', '.');
            if (
                standardizedDesconto.trim() !== '' &&
                (isNaN(parseFloat(standardizedDesconto)) ||
                parseFloat(standardizedDesconto) < 0)
            ) {
                newErrors.desconto = 'Desconto deve ser um número válido e não negativo.';
            }
            
            let hasAtLeastOneValidItem = false;
            items.forEach((item, index) => {
                const materialIsSet = item.material || item.materialId;
                const quantidadeIsSet = String(item.quantidade).replace(',', '.').trim() !== '';
                const valorUnitarioIsSet = String(item.valorUnitario).replace(',', '.').trim() !== '';

                if (materialIsSet || quantidadeIsSet || valorUnitarioIsSet) {
                    if (!materialIsSet)
                        newErrors[`item_${index}_material`] = 'Material é obrigatório.';
                    const stdQty = String(item.quantidade).replace(',', '.');
                    if (stdQty === '' || parseFloat(stdQty) <= 0)
                        newErrors[`item_${index}_quantidade`] = 'Quantidade deve ser positiva.';
                    const stdVU = String(item.valorUnitario).replace(',', '.');
                    if (stdVU === '' || parseFloat(stdVU) < 0)
                        newErrors[`item_${index}_valorUnitario`] = 'Valor unitário deve ser positivo ou zero.';

                    if (materialIsSet && parseFloat(stdQty) > 0 && parseFloat(stdVU) >= 0)
                        hasAtLeastOneValidItem = true;
                }
            });
            
            // CORREÇÃO CRÍTICA: Sempre exigir pelo menos um item válido
            if (!hasAtLeastOneValidItem) {
                newErrors.form = 'Uma compra deve ter pelo menos um item válido com material, quantidade e valor unitário preenchidos.';
            }
            
            return { isValid: Object.keys(newErrors).length === 0, errors: newErrors };
        }
        
        function runTests() {
            const resultsDiv = document.getElementById('results');
            
            // Teste 1: Compra sem itens
            const test1 = validateForm([], '1', '2025-01-22', '0');
            resultsDiv.innerHTML += `<div class="test-result ${test1.isValid ? 'error' : 'success'}">
                <strong>Teste 1 - Compra sem itens:</strong> ${test1.isValid ? 'FALHOU - Permitiu salvar sem itens!' : 'PASSOU - Rejeitou compra sem itens'}
                <br>Erros: ${JSON.stringify(test1.errors, null, 2)}
            </div>`;
            
            // Teste 2: Compra com item vazio
            const test2 = validateForm([{material: null, materialId: null, quantidade: '', valorUnitario: ''}], '1', '2025-01-22', '0');
            resultsDiv.innerHTML += `<div class="test-result ${test2.isValid ? 'error' : 'success'}">
                <strong>Teste 2 - Compra com item vazio:</strong> ${test2.isValid ? 'FALHOU - Permitiu salvar com item vazio!' : 'PASSOU - Rejeitou item vazio'}
                <br>Erros: ${JSON.stringify(test2.errors, null, 2)}
            </div>`;
            
            // Teste 3: Compra com item válido
            const test3 = validateForm([{material: {id: 1}, materialId: 1, quantidade: '10', valorUnitario: '100'}], '1', '2025-01-22', '0');
            resultsDiv.innerHTML += `<div class="test-result ${test3.isValid ? 'success' : 'error'}">
                <strong>Teste 3 - Compra com item válido:</strong> ${test3.isValid ? 'PASSOU - Aceitou item válido' : 'FALHOU - Rejeitou item válido!'}
                <br>Erros: ${JSON.stringify(test3.errors, null, 2)}
            </div>`;
            
            // Teste 4: Compra sem obra
            const test4 = validateForm([{material: {id: 1}, materialId: 1, quantidade: '10', valorUnitario: '100'}], '', '2025-01-22', '0');
            resultsDiv.innerHTML += `<div class="test-result ${test4.isValid ? 'error' : 'success'}">
                <strong>Teste 4 - Compra sem obra:</strong> ${test4.isValid ? 'FALHOU - Permitiu salvar sem obra!' : 'PASSOU - Rejeitou compra sem obra'}
                <br>Erros: ${JSON.stringify(test4.errors, null, 2)}
            </div>`;
            
            // Teste 5: Compra sem data
            const test5 = validateForm([{material: {id: 1}, materialId: 1, quantidade: '10', valorUnitario: '100'}], '1', '', '0');
            resultsDiv.innerHTML += `<div class="test-result ${test5.isValid ? 'error' : 'success'}">
                <strong>Teste 5 - Compra sem data:</strong> ${test5.isValid ? 'FALHOU - Permitiu salvar sem data!' : 'PASSOU - Rejeitou compra sem data'}
                <br>Erros: ${JSON.stringify(test5.errors, null, 2)}
            </div>`;
        }
        
        // Executar testes quando a página carregar
        window.onload = runTests;
    </script>
</body>
</html>