<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MaterialAutocomplete Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 50px auto;
        padding: 20px;
      }
      .test-section {
        border: 1px solid #ccc;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
      }
      .debug-panel {
        background: #f5f5f5;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .success {
        background: #28a745;
      }
      .error {
        background: #dc3545;
      }
    </style>
  </head>
  <body>
    <h1>MaterialAutocomplete Component Test</h1>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // Mock MaterialAutocomplete component
      const MaterialAutocomplete = ({
        value,
        onChange,
        onMaterialSelect,
        placeholder = 'Selecione um material...',
        error,
      }) => {
        const [inputValue, setInputValue] = useState(value?.nome || '');
        const [suggestions, setSuggestions] = useState([]);
        const [showSuggestions, setShowSuggestions] = useState(false);
        const [highlightedIndex, setHighlightedIndex] = useState(-1);
        const inputRef = useRef(null);

        const mockMaterials = [
          {
            id: 1,
            nome: 'AREIA',
            unidade_medida: 'mÂ³',
            categoria_uso_padrao: 'CONSUMO',
          },
          {
            id: 2,
            nome: 'CIMENTO',
            unidade_medida: 'kg',
            categoria_uso_padrao: 'CONSUMO',
          },
          {
            id: 3,
            nome: 'PEDRA',
            unidade_medida: 'mÂ³',
            categoria_uso_padrao: 'CONSUMO',
          },
          {
            id: 4,
            nome: 'TINTA',
            unidade_medida: 'l',
            categoria_uso_padrao: 'CONSUMO',
          },
        ];

        const handleInputChange = e => {
          const value = e.target.value;
          setInputValue(value);

          if (value.length > 0) {
            const filtered = mockMaterials.filter(m =>
              m.nome.toLowerCase().includes(value.toLowerCase())
            );
            setSuggestions(filtered);
            setShowSuggestions(true);
          } else {
            setSuggestions([]);
            setShowSuggestions(false);
          }

          setHighlightedIndex(-1);
        };

        const handleSuggestionClick = material => {
          console.log('ðŸ§ª TEST: Suggestion clicked:', material);
          setInputValue(material.nome);
          setShowSuggestions(false);
          setHighlightedIndex(-1);

          if (onMaterialSelect) {
            onMaterialSelect(material);
          }
        };

        const handleKeyDown = e => {
          console.log('ðŸ§ª TEST: Key pressed:', e.key, {
            showSuggestions,
            highlightedIndex,
            suggestionsCount: suggestions.length,
          });

          if (!showSuggestions) return;

          switch (e.key) {
            case 'ArrowDown':
              e.preventDefault();
              setHighlightedIndex(prev =>
                prev < suggestions.length - 1 ? prev + 1 : 0
              );
              break;
            case 'ArrowUp':
              e.preventDefault();
              setHighlightedIndex(prev =>
                prev > 0 ? prev - 1 : suggestions.length - 1
              );
              break;
            case 'Enter':
              e.preventDefault();
              if (
                highlightedIndex >= 0 &&
                highlightedIndex < suggestions.length
              ) {
                handleSuggestionClick(suggestions[highlightedIndex]);
              }
              break;
            case 'Tab':
              if (
                highlightedIndex >= 0 &&
                highlightedIndex < suggestions.length
              ) {
                e.preventDefault();
                handleSuggestionClick(suggestions[highlightedIndex]);
              }
              break;
            case 'Escape':
              setShowSuggestions(false);
              setHighlightedIndex(-1);
              break;
          }
        };

        return (
          <div className="relative">
            <input
              ref={inputRef}
              type="text"
              value={inputValue}
              onChange={handleInputChange}
              onKeyDown={handleKeyDown}
              onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}
              placeholder={placeholder}
              className={`w-full px-3 py-2 border rounded ${
                error ? 'border-red-500' : 'border-gray-300'
              }`}
            />

            {showSuggestions && suggestions.length > 0 && (
              <ul className="absolute z-10 w-full bg-white border border-gray-300 rounded mt-1 max-h-60 overflow-y-auto">
                {suggestions.map((material, index) => (
                  <li
                    key={material.id}
                    className={`px-3 py-2 cursor-pointer ${
                      index === highlightedIndex
                        ? 'bg-blue-100'
                        : 'hover:bg-gray-100'
                    }`}
                    onClick={() => handleSuggestionClick(material)}
                  >
                    {material.nome} ({material.unidade_medida})
                  </li>
                ))}
              </ul>
            )}

            {error && <div className="text-red-500 text-sm mt-1">{error}</div>}
          </div>
        );
      };

      // Test component
      const TestComponent = () => {
        const [selectedMaterial, setSelectedMaterial] = useState(null);
        const [error, setError] = useState(null);
        const [testResults, setTestResults] = useState([]);

        const handleMaterialSelect = material => {
          console.log('ðŸ§ª TEST: Material selected:', material);
          setSelectedMaterial(material);
          setError(null);
        };

        const runValidation = () => {
          if (!selectedMaterial) {
            setError('Material Ã© obrigatÃ³rio');
            return false;
          }
          return true;
        };

        const addTestResult = (testName, success, details = '') => {
          setTestResults(prev => [
            ...prev,
            {
              testName,
              success,
              details,
              timestamp: new Date().toLocaleTimeString(),
            },
          ]);
        };

        const clearResults = () => {
          setTestResults([]);
          setSelectedMaterial(null);
          setError(null);
        };

        return (
          <div>
            <div className="test-section">
              <h2>Component Test</h2>
              <MaterialAutocomplete
                value={selectedMaterial}
                onMaterialSelect={handleMaterialSelect}
                error={error}
              />

              <div className="debug-panel">
                <strong>Current State:</strong>
                <br />
                Selected: {selectedMaterial ? selectedMaterial.nome : 'None'}
                <br />
                Error: {error || 'None'}
              </div>
            </div>

            <div className="test-section">
              <h2>Automated Tests</h2>
              <button onClick={clearResults}>Clear Results</button>
              <button onClick={runValidation}>Validate</button>

              <div>
                <h3>Test Results:</h3>
                {testResults.length === 0 ? (
                  <p>No tests run yet</p>
                ) : (
                  <ul>
                    {testResults.map((result, index) => (
                      <li
                        key={index}
                        className={result.success ? 'success' : 'error'}
                      >
                        {result.testName}: {result.success ? 'PASS' : 'FAIL'} -{' '}
                        {result.timestamp}
                        {result.details && <br />}
                        {result.details}
                      </li>
                    ))}
                  </ul>
                )}
              </div>
            </div>

            <div className="test-section">
              <h2>Manual Test Instructions</h2>
              <ol>
                <li>Type "areia" in the input above</li>
                <li>Press arrow down to highlight "AREIA"</li>
                <li>Press Enter or Tab to select</li>
                <li>Click "Validate" to check for errors</li>
                <li>Check browser console for detailed logs</li>
              </ol>
            </div>
          </div>
        );
      };

      ReactDOM.render(<TestComponent />, document.getElementById('root'));
    </script>
  </body>
</html>
